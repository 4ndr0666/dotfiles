# This script adds custom kernel parameters to the GRUB configuration
# and ensures specific settings are applied.

# Function to add a kernel parameter if it doesn't already exist
add_kernel_param() {
    local param="$1"
    if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ $param ]]; then
        GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }$param"
    fi
}

# Add custom kernel parameters if they are not already present
if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ fsck.repair=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }fsck.repair=yes"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ nosmt ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }nosmt"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ swapaccount=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }swapaccount=1"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ zswap.enabled=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }zswap.enabled=yes"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ mitigations=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }mitigations=auto"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ rootfstype=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }rootfstype=btrfs"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ cgroup_enable=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }cgroup_enable=memory"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ sysrq_always_enabled=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }sysrq_always_enabled=1"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ systemd.unified_cgroup_hierarchy=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }systemd.unified_cgroup_hierarchy=1"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ disable_ipv6=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }disable_ipv6=1"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ ipv6.autoconf=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }ipv6.autoconf=0"
fi

if [[ ! $GRUB_CMDLINE_LINUX_DEFAULT =~ accept_ra=[^[:space:]]+ ]]; then
    GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT:+$GRUB_CMDLINE_LINUX_DEFAULT }accept_ra=0"
fi

# Ensure OS Prober is enabled unless explicitly disabled
if [ -z "${GRUB_DISABLE_OS_PROBER+x}" ]; then
    GRUB_DISABLE_OS_PROBER=false
fi
